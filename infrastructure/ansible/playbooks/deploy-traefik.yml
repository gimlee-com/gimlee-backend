---
- name: Deploy Traefik
  hosts: app
  become: true
  vars:
    domain: "{{ lookup('env', 'DOMAIN') }}"
    email: "{{ lookup('env', 'EMAIL') }}"
  tasks:
    - name: Create Traefik directory
      file:
        path: /opt/traefik
        state: directory
        mode: '0755'

    - name: Create acme.json with correct permissions
      file:
        path: /opt/traefik/acme.json
        state: touch
        mode: '0600'

    - name: Run Traefik container
      community.docker.docker_container:
        name: traefik
        image: traefik:v3.6.5
        pull: true
        restart_policy: always
        command:
          - "--api.dashboard=true"
          - "--api.insecure=false"
          - "--ping=true"
          - "--providers.docker=true"
          - "--providers.docker.exposedbydefault=false"
          - "--entrypoints.web.address=:80"
          - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
          - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
          - "--entrypoints.websecure.address=:443"
          - "--certificatesresolvers.myresolver.acme.httpchallenge=true"
          - "--certificatesresolvers.myresolver.acme.httpchallenge.entrypoint=web"
          - "--certificatesresolvers.myresolver.acme.email={{ email }}"
          - "--certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json"
          - "--experimental.plugins.bouncer.modulename=github.com/fargio/traefik-bouncer"
          - "--experimental.plugins.bouncer.version=v0.4.0"
          - "--experimental.plugins.fingerprint.modulename=github.com/traefik-plugins/client-fingerprint"
          - "--experimental.plugins.fingerprint.version=v0.1.0"
        ports:
          - "80:80"
          - "443:443"
        volumes:
          - "/var/run/docker.sock:/var/run/docker.sock:ro"
          - "/opt/traefik/acme.json:/letsencrypt/acme.json"
        labels:
          traefik.enable: "true"

          # Middleware: CrowdSec Bouncer
          traefik.http.middlewares.crowdsec-bouncer.plugin.bouncer.enabled: "true"
          traefik.http.middlewares.crowdsec-bouncer.plugin.bouncer.crowdsecLapiScheme: "http"
          traefik.http.middlewares.crowdsec-bouncer.plugin.bouncer.crowdsecLapiHost: "crowdsec:8080"
          traefik.http.middlewares.crowdsec-bouncer.plugin.bouncer.crowdsecLapiKey: "{{ crowdsec_lapi_key }}"
          traefik.http.middlewares.crowdsec-bouncer.plugin.bouncer.forwardedHeadersCustomName: "X-Crowdsec-Bot-Score"

          # Middleware: Client Fingerprint
          traefik.http.middlewares.client-fingerprint.plugin.fingerprint.headerName: "X-Client-Id"

          # Router for Traefik Health Check
          traefik.http.routers.health.rule: "Path(`/health`)"
          traefik.http.routers.health.entrypoints: "web"
          traefik.http.routers.health.service: "ping@internal"

          # Router for Traefik Dashboard (Secure)
          traefik.http.routers.traefik-dashboard.rule: "Host(`traefik.{{ domain }}`)"
          traefik.http.routers.traefik-dashboard.entrypoints: "websecure"
          traefik.http.routers.traefik-dashboard.tls: "true"
          traefik.http.routers.traefik-dashboard.tls.certresolver: "myresolver"
          traefik.http.routers.traefik-dashboard.service: "api@internal"
